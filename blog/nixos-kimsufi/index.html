<!doctype html>
<html lang="fr">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <title>Let&#x27;s shuffle bits - NixOS chez kimsufi</title>

    <!-- CSS -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;greizgh.github.io&#x2F;tachyons.min.css">
    <link rel="stylesheet" href="https:&#x2F;&#x2F;greizgh.github.io&#x2F;style.css">

    
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https:&#x2F;&#x2F;greizgh.github.io&#x2F;rss.xml">
    

    
<meta name="description" content="Installation de NixOS sur un serveur kimsufi" />

  </head>

  <body>
    <header class="w-100 bg-dark-gray pa2 white">
      <div class="w-80-ns center pa2">
        <a href="/" class="link hover-orange f3 lh-solid fw6">Let&#x27;s shuffle bits</a>
      </div>
    </header>

    <div class="center w-40-ns pa3">
      
<div class="flex justify-center">
  <article>
    <h1 class="orange lh-title">
      <a href="https:&#x2F;&#x2F;greizgh.github.io&#x2F;blog&#x2F;nixos-kimsufi&#x2F;" class="link hover-black">
        NixOS chez kimsufi
      </a>
    </h1>
    <div class="w-100 tr f6">
      <time><small>üñãÔ∏è 15&#x2F;06&#x2F;2019</small></time>
    </div>
    <div class="lh-copy measure-wide">
      <p>Notes rapides concernant l'installation de NixOS sur un serveur <a href="https://www.kimsufi.com/fr/">kimsufi</a>.
Kimsufi permet de jouer avec des machines d√©di√©es pour moins de 5‚Ç¨ par mois.
C'est l'occasion de tester <a href="https://nixos.org/">NixOS</a>, une distribution dont la promesse me fait de l'≈ìil.</p>
<p id="zola-continue-reading"><a name="continue-reading"></a></p>
<h2 id="objectif">Objectif</h2>
<p>La machine, une fois configur√©e doit remplir les crit√®res suivants:</p>
<ul>
<li>le disque doit √™tre chiffr√© (√† l'exception de la partition <code>/boot</code>);</li>
<li>au boot, la machine doit attendre la saisie de la passphrase en SSH;</li>
</ul>
<p><strong>Note</strong>: Lors de mes diff√©rents tests, la machine s'est retrouv√©e plusieurs fois &quot;hors ligne&quot; (ne r√©pondant plus au ping). Il s'av√®re que cela d√©clenche une alerte chez kimsufi.
Pour √©viter de voir votre machine r√©initialis√©e (et pour la tranquillit√© des techniciens d'astreinte), il peut √™tre bon de d√©sactiver le monitoring le temps de l'installation.</p>
<h2 id="installation">Installation</h2>
<p>Kimsufi ne propose pas d'installation int√©gr√©e de NixOS et on ne peut pas booter une ISO arbitraire.
On va s'en sortir avec l'<a href="https://nixos.org/nixos/manual/index.html#sec-installing-from-other-distro">installation depuis une autre distribution</a>.</p>
<p>Il existe d'autres alternatives: il est possible de booter une iso via qemu.
J'ai tent√© mais m√™me apr√®s plusieurs heures je n'ai jamais atteint un shell interactif.</p>
<h3 id="mode-rescue">Mode rescue</h3>
<p>La premi√®re √©tape consiste √† avoir un syst√®me minimal depuis lequel d√©rouler l'installation.
Le plus simple est de passer en mode &quot;rescue&quot; pour avoir une debian.
Cela correspond √† l'option &quot;rescue64-pro&quot; du dashboard kimsufi.</p>
<h3 id="partitionnement">Partitionnement</h3>
<p>Une fois connect√© en root sur le rescue, on va monter le disque du serveur sur <code>/mnt</code> et le partitionner comme on le sent.</p>
<p>On va avoir trois partitions:</p>
<ul>
<li>/boot en ext4 non chiffr√©e;</li>
<li>/ en ext4 sur du LUKS;</li>
<li>une partition swap;</li>
</ul>
<p>Il est conseill√© de monter la swap (<code>swapon /dev/sda3</code>) d√®s que possible vu la m√©moire limit√©e de la machine.</p>
<h3 id="installation-de-nix">Installation de nix</h3>
<p>Avant de se lancer dans l'installation de nix (le gestionnaire de paquets de NixOS), il nous faut un utilisateur non root.
En effet, nix refusera de s'installer en tant que root, mais n√©cessite l'utilisation de sudo.</p>
<p>Donc:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">apt install sudo
useradd -m -G wheel setupuser
su setupuser
</span></pre>
<p>Et c'est parti pour l'installation de nix:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">curl https://nixos.org/nix/install | sh
. $HOME/.nix-profile/etc/profile.d/nix.sh
</span></pre>
<p>On bascule tout de suite sur le channel stable:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">nix-channel --add https://nixos.org/channels/nixos-19.03 nixpkgs
</span></pre>
<p>Et on installe les outils d'installation:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">nix-env -iE &quot;_: with import &lt;nixpkgs/nixos&gt; { configuration = {}; }; with config.system.build; [ nixos-generate-config nixos-install nixos-enter ]&quot;
</span></pre>
<p>Je n'installe pas le manuel, c'est d√©lib√©r√© puisqu'on est en remote; le manuel je peux le lire depuis la machine de travail et le rescue est uniquement en RAM.
Donc √©vitons de surcharger inutilement la m√©moire.</p>
<p>On peut g√©n√©rer la config:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">sudo `which nixos-generate-config` --root /mnt
</span></pre>
<p>Avant de lancer l'installation, il va falloir faire quelques adaptation √† la configuration.</p>
<h3 id="ssh-dans-l-initramfs">SSH dans l'initramfs</h3>
<p>Il est imp√©ratif d'ajouter le pilote de la carte r√©seau √† l'initramfs, au risque d'√™tre bloqu√© au boot (puisqu'on attend la passphrase en ssh).
Devinez comment je m'en suis rendu compte...</p>
<p>Dans hardware-configuration.conf, on ajoute le driver <code>e1000e</code>:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">boot.initrd.availableKernelModules = [ &quot;uhci_hcd&quot; &quot;ahci&quot; &quot;e1000e&quot; ];
</span></pre>
<p>On peut maintenant configurer l'init dans configuration.conf:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">  boot.initrd.network.enable = true;
  boot.initrd.network.ssh.enable = true;
  boot.initrd.network.ssh.hostRSAKey = /boot/dropbear_rsa_host_key;
  boot.initrd.network.ssh.authorizedKeys = [&quot;ssh-rsa XXXXX user@machine&quot;];
</span></pre>
<p>La cl√© RSA doit √™tre disponible √† la cr√©ation de l'initramfs, mais peut se trouver compl√®tement ailleurs que sur /boot.</p>
<h3 id="installation-1">Installation</h3>
<p>On est presque pr√™t √† lancer l'installation.
Presque, parce que sur debian le $PATH user ne contient pas l'utilitaire chroot.</p>
<p>On va donc l'exposer:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">export PATH=/usr/sbin:/sbin:$PATH
</span></pre>
<p>Et normalement l'installation devrait bien se passer:</p>
<pre style="background-color:#272822;">
<span style="color:#f8f8f2;">sudo PATH=&quot;$PATH&quot; NIX_PATH=&quot;$NIX_PATH&quot; `which nixos-install` --root /mnt
</span></pre>
<p>Au boot, la machine va attendre la passphrase avant de charger le syst√®me.</p>
<h2 id="autres-ressources">Autres ressources</h2>
<ul>
<li><a href="https://www.codejam.info/2015/12/installing-nixos-on-a-kimsufi.html">une autre m√©thode d'installation, qui g√®re l'IPv6</a></li>
<li><a href="https://it-offshore.co.uk/linux/alpine-linux/64-alpine-linux-kvm-vps-without-a-custom-iso">booter une iso via QEMU</a></li>
</ul>

    </div>
  </article>
</div>

    </div>

    <footer class="mt5 pa3 bg-dark-gray near-white">
      <div class="tc mt3">
        
        <a class="link black hover-silver dib h2 w2" href="https:&#x2F;&#x2F;greizgh.github.io&#x2F;rss.xml">
          <svg fill="currentColor" viewBox="0 0 24 24">
    <path d="M5,3H19A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3M7.5,15A1.5,1.5 0 0,0 6,16.5A1.5,1.5 0 0,0 7.5,18A1.5,1.5 0 0,0 9,16.5A1.5,1.5 0 0,0 7.5,15M6,10V12A6,6 0 0,1 12,18H14A8,8 0 0,0 6,10M6,6V8A10,10 0 0,1 16,18H18A12,12 0 0,0 6,6Z" />
          </svg>
        </a>
        
        <a class="link black hover-silver dib h2 w2" href="https://github.com/greizgh" title="GitHub">
          <svg fill="currentColor" viewBox="0 0 24 24">
    <path d="M5,3H19A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H14.56C14.24,20.93 14.23,20.32 14.23,20.11L14.24,17.64C14.24,16.8 13.95,16.25 13.63,15.97C15.64,15.75 17.74,15 17.74,11.53C17.74,10.55 17.39,9.74 16.82,9.11C16.91,8.89 17.22,7.97 16.73,6.73C16.73,6.73 15.97,6.5 14.25,7.66C13.53,7.46 12.77,7.36 12,7.35C11.24,7.36 10.46,7.46 9.75,7.66C8.03,6.5 7.27,6.73 7.27,6.73C6.78,7.97 7.09,8.89 7.18,9.11C6.61,9.74 6.26,10.55 6.26,11.53C6.26,15 8.36,15.75 10.36,16C10.1,16.2 9.87,16.6 9.79,17.18C9.27,17.41 7.97,17.81 7.17,16.43C7.17,16.43 6.69,15.57 5.79,15.5C5.79,15.5 4.91,15.5 5.73,16.05C5.73,16.05 6.32,16.33 6.73,17.37C6.73,17.37 7.25,19.12 9.76,18.58L9.77,20.11C9.77,20.32 9.75,20.93 9.43,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3Z" />
          </svg>
        </a>
        <a class="link black hover-silver dib h2 w2" href="https://gitlab.com/greizgh" title="GitLab">
          <svg fill="currentColor" viewBox="0 0 586 559">
            <path d="M461.514,298.355l-18.049-55.587c0.008,0.025,0.011,0.051,0.019,0.076c-0.009-0.029-0.014-0.058-0.022-0.087
                     c-0.001-0.002-0.001-0.003-0.001-0.005c0-0.001,0-0.002,0-0.002l-35.83-110.31c-1.96-5.811-7.353-9.711-13.536-9.663
                     c-6.201,0.032-11.446,3.857-13.364,9.748L346.721,237.23H239.408l-34.074-104.712c-1.916-5.886-7.162-9.71-13.362-9.742
                     c-0.025,0-0.049,0-0.075,0c-6.105,0-11.509,3.876-13.49,9.752l-35.732,110.211l-0.005,0.014c0,0.001,0,0.002,0,0.003
                     c-0.009,0.028-0.013,0.056-0.022,0.084c0.008-0.025,0.011-0.051,0.019-0.076l-18.115,55.591c-2.725,8.392,0.232,17.512,7.36,22.697
                     L288.328,434.7c0.023,0.017,0.049,0.027,0.072,0.044c0.067,0.048,0.132,0.097,0.2,0.142c-0.064-0.043-0.124-0.09-0.187-0.134
                     c0,0,0-0.001-0.001-0.001c0.01,0.008,0.022,0.013,0.033,0.02c0.009,0.006,0.018,0.01,0.027,0.016
                     c0.001,0.001,0.002,0.002,0.004,0.003c0.242,0.168,0.493,0.322,0.753,0.463c0.036,0.02,0.068,0.045,0.104,0.064
                     c0.001,0,0.001,0.001,0.002,0.001c0.022,0.011,0.042,0.025,0.064,0.036c0.017,0.008,0.035,0.013,0.051,0.021
                     c0.012,0.006,0.025,0.01,0.037,0.015c0.029,0.014,0.061,0.023,0.09,0.038c0.136,0.065,0.279,0.118,0.419,0.175
                     c0.131,0.054,0.258,0.117,0.392,0.164c0.006,0.002,0.011,0.005,0.017,0.007c0.022,0.008,0.042,0.019,0.065,0.027
                     c0.028,0.01,0.055,0.021,0.083,0.03c0.011,0.003,0.022,0.005,0.033,0.008c0.035,0.011,0.073,0.016,0.108,0.026
                     c0.013,0.004,0.028,0.006,0.042,0.01c0.188,0.057,0.383,0.098,0.577,0.141c0.076,0.017,0.149,0.041,0.226,0.055
                     c0.011,0.002,0.021,0.006,0.033,0.008c0.025,0.005,0.048,0.014,0.074,0.018c0.041,0.007,0.081,0.02,0.123,0.026
                     c0.033,0.005,0.067,0.003,0.1,0.008c0.006,0.001,0.011,0,0.017,0.001c0.002,0,0.003,0,0.005,0c0.369,0.053,0.743,0.09,1.124,0.09
                     c0.002,0,0.004,0,0.007,0l0,0c0.001,0,0.002,0,0.002,0c0,0,0.001,0,0.001,0c0.001,0,0.002,0,0.003,0
                     c0.382,0,0.756-0.037,1.126-0.09c0.001,0,0.003,0,0.004,0c0.006-0.001,0.012,0,0.018-0.001c0.033-0.005,0.068-0.003,0.101-0.008
                     c0.042-0.007,0.082-0.019,0.124-0.026c0.025-0.004,0.048-0.013,0.073-0.018c0.011-0.002,0.021-0.006,0.032-0.008
                     c0.078-0.015,0.153-0.039,0.231-0.056c0.191-0.042,0.383-0.083,0.57-0.139c0.013-0.004,0.026-0.005,0.039-0.009
                     c0.037-0.011,0.075-0.016,0.112-0.027c0.011-0.004,0.023-0.005,0.034-0.008c0.029-0.009,0.057-0.021,0.085-0.031
                     c0.022-0.008,0.042-0.019,0.064-0.027c0.006-0.002,0.011-0.005,0.017-0.007c0.142-0.05,0.276-0.116,0.415-0.173
                     c0.129-0.054,0.261-0.102,0.387-0.162c0.031-0.015,0.064-0.024,0.094-0.039c0.012-0.006,0.026-0.01,0.038-0.016
                     c0.017-0.008,0.035-0.013,0.052-0.022c0.023-0.012,0.045-0.026,0.067-0.037c0,0,0.001,0,0.001-0.001
                     c0.037-0.019,0.07-0.046,0.107-0.066c0.258-0.14,0.508-0.293,0.749-0.46c0.019-0.013,0.041-0.023,0.061-0.037
                     c0.005-0.004,0.011-0.006,0.016-0.01c0.023-0.017,0.05-0.028,0.073-0.045l156.44-113.65
                     C461.282,315.867,464.239,306.747,461.514,298.355z M394.194,142.774l30.68,94.456h-61.36L394.194,142.774z M419.501,253.202
                     l-12.519,16.041L314.648,387.55l43.677-134.348H419.501z M285.428,430.707C285.428,430.707,285.428,430.707,285.428,430.707
                     c0.008,0.024,0.021,0.046,0.029,0.071C285.449,430.753,285.436,430.731,285.428,430.707z M271.42,387.558L166.624,253.202l0,0
                     h61.18L271.42,387.558z M191.875,142.773l30.737,94.457h-61.36L191.875,142.773z M141.304,308.133
                     c-1.516-1.103-2.144-3.05-1.563-4.838l13.466-41.325l98.67,126.502L141.304,308.133z M288.053,434.489
                     c-0.031-0.025-0.061-0.052-0.091-0.078c-0.006-0.005-0.012-0.012-0.019-0.017c-0.06-0.05-0.119-0.101-0.177-0.153
                     c-0.114-0.099-0.226-0.2-0.333-0.306c0.009,0.008,0.019,0.015,0.028,0.023c0.012,0.011,0.025,0.02,0.037,0.031
                     c0.229,0.219,0.47,0.425,0.722,0.615c0.003,0.002,0.005,0.005,0.008,0.007c0.012,0.009,0.022,0.02,0.034,0.03
                     C288.193,434.591,288.121,434.543,288.053,434.489z M293.028,402.392l-25.665-79.059l-22.766-70.131h96.933L293.028,402.392z
                     M298.281,434.241c-0.06,0.052-0.118,0.104-0.179,0.154c-0.007,0.006-0.014,0.013-0.021,0.019c-0.031,0.025-0.06,0.052-0.09,0.077
		             c-0.066,0.053-0.138,0.101-0.207,0.152c0.012-0.009,0.022-0.021,0.035-0.029c0.002-0.002,0.004-0.004,0.006-0.006
		             c0.252-0.19,0.492-0.394,0.719-0.613c0.009-0.009,0.02-0.016,0.029-0.024c0.012-0.011,0.025-0.02,0.036-0.031
		             C298.503,434.043,298.392,434.143,298.281,434.241z M444.766,308.13l-110.557,80.317l98.703-126.467l13.412,41.307
		             C446.906,305.083,446.279,307.03,444.766,308.13z"/>
          </svg>
        </a>
      </div>


      <small class="ma1 db tc gray">Carefully handcrafted with ‚ù§ - CC-BY-NC-SA</small>
    </footer>

    
    
  </body>

</html>
