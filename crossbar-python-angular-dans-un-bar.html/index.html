<!doctype html>
<html lang="fr">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
<link rel="canonical" href="https:&#x2F;&#x2F;greizgh.eu&#x2F;crossbar-python-angular-dans-un-bar.html&#x2F;" />
<meta http-equiv="refresh" content="0; URL=https:&#x2F;&#x2F;greizgh.eu&#x2F;crossbar-python-angular-dans-un-bar.html&#x2F;" />


    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <title>Let&#x27;s shuffle bits - C&#x27;est crossbar, python et angular qui rentrent dans un bar...</title>

    <!-- CSS -->
    <link rel="stylesheet" href="https:&#x2F;&#x2F;greizgh.eu&#x2F;tachyons.min.css">
    <link rel="stylesheet" href="https:&#x2F;&#x2F;greizgh.eu&#x2F;style.css">

    

    
<meta name="description" content="Ou comment r√©soudre un probl√®me de concurrence avec une application web bas√©e sur crossbar, python et angular." />

  </head>

  <body>
    <header class="w-100 bg-dark-gray pa2 white">
      <div class="w-80-ns center pa2">
        <a href="/" class="link hover-orange f3 lh-solid fw6">Let&#x27;s shuffle bits</a>
      </div>
    </header>

    <div class="center w-40-ns pa3">
      
<div class="flex justify-center">
  <article>
    <h1 class="orange lh-title">
      <a href="https:&#x2F;&#x2F;greizgh.eu&#x2F;crossbar-python-angular-dans-un-bar.html&#x2F;" class="link hover-black">
        C&#x27;est crossbar, python et angular qui rentrent dans un bar...
      </a>
    </h1>
    <div class="w-100 tr f6">
      <time><small>üñãÔ∏è 09&#x2F;08&#x2F;2015</small></time>
    </div>
    <div class="lh-copy measure-wide">
      <p>Depuis que la soci√©t√© o√π je travaille a d√©m√©nag√©, il y a quelques
semaines de √ßa, mes coll√®gues et moi sommes confront√©s √† un probl√®me
majeur: les toilettes sont sur le palier. Le probl√®me avec cette
topologie, c'est qu'il est impossible de savoir √† l'avance si les
chiottes sont libres ou pas. On se retrouve donc souvent devant une
porte ferm√©e, dans l'impossibilit√© d'assouvir nos besoins les plus
naturels.</p>
<p>C'est dans ces moments-l√† que les plus bas instincts se r√©veillent et
nous poussent √† commettre les pires attrocit√©s. Il est bien connu que
l'Homme est un loup pour l'Homme. Ainsi, dans le but de maintenir une
atmosph√®re conviviale et d√©tendue, il est n√©cessaire de trouver une
solution.</p>
<span id="continue-reading"></span>
<p><img src="https://media.giphy.com/media/1WQLKmc1Gfhny/giphy.gif" alt="My turn." /></p>
<p>En attendant un syst√®me de supervision des chiottes en temps r√©el (on y
travaille, √† base d'<a href="https://www.arduino.cc/">Arduino</a>), un syst√®me de
<em>verrou</em> fera l'affaire.</p>
<p>L'id√©e est la suivante: un serveur central g√®re l'√©tat de la
ressource, les participants peuvent la verrouiller ou la lib√©rer. Oui
c'est une mutex IRL. Ou un b√¢ton de parole. Mais pour les chiottes.</p>
<p>Une petite application comme celle-ci me semble un bon pr√©texte pour
jouer un peu avec <a href="http://crossbar.io/">crossbar</a> et
<a href="https://angular.io/">angular</a>.</p>
<p><a href="https://angular.io/">Angular</a>, c'est un framework MVC javascript
d√©velopp√© par Google. <a href="http://crossbar.io/">Crossbar</a>, c'est un routeur
<a href="http://wamp.ws/">WAMP</a> (Web Application Messaging Protocol). En gros √ßa
permet de faire causer plein de composants h√©t√©rog√®nes ensemble. C'est
assez puissant, √ßa permet de faire du Pub/Sub et du RPC super
facilement. Pour plus de d√©tails, je vous invite √† lire l'<a href="http://sametmax.com/crossbar-le-futur-des-applications-web-python/">explication
de
Sam</a>.</p>
<h2 id="le-plan">Le plan</h2>
<p>J'imagine bien une petite application web avec un gros bouton &quot;Je vais
aux chiottes&quot; qui se transforme en &quot;J'ai fini!&quot; au clic. Bien s√ªr
l'id√©e c'est de partager avec tout le monde (anonymement) l'√©tat de
la ressource histoire de ne pas se retrouver devant une <a href="https://fr.wikipedia.org/wiki/Situation_de_comp%C3%A9tition">race
condition</a>.</p>
<p>Pour √©viter les abus, seul le participant ayant verrouill√© la ressource
peut la d√©verrouiller. On identifiera les participants par un uuid
g√©n√©r√© par le backend.</p>
<p>Sur le plan technique, on va s'appuyer sur les technologies suivantes:</p>
<ul>
<li><a href="http://crossbar.io/">crossbar</a> comme routeur
<a href="http://wamp.ws/">WAMP</a></li>
<li><a href="https://www.python.org/">python</a> dans sa version 3 comme langage
serveur</li>
<li><a href="https://angular.io/">angular</a> premier du nom pour la partie
frontend</li>
</ul>
<h2 id="backend">Backend</h2>
<h3 id="crossbar">Crossbar</h3>
<p><a href="http://autobahn.ws/">Autobahn</a> (la lib pour causer
<a href="http://wamp.ws/">WAMP</a>) est compatible python3, mais
<a href="http://crossbar.io/">crossbar</a>, le routeur ne l'est pas encore. Du
coup on va se cr√©er deux environnements virtuels pour bosser: un pour
crossbar et un pour notre backend.</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">virtualenv backend_env
virtualenv crossbar_env</span><span style="font-style:italic;color:#fd971f;"> -p</span><span style="color:#f8f8f2;"> python2
</span></code></pre>
<p>Avec <em>crossbar_env</em>, on bootstrap crossbar:</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">crossbar init
</span></code></pre>
<p>Par la suite, d√®s qu'on touchera √† crossbar, on le fera avec
<em>crossbar_env</em>.</p>
<p>On va tout de suite configurer crossbar, √ßa sera fait. Tout se passe
dans le fichier <em>.crossbar/config.json</em> qui a normalement du √™tre cr√©√©
lors de notre crossbar init:</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">{
   </span><span style="color:#e6db74;">&quot;controller&quot;</span><span style="color:#f8f8f2;">: {
   },
   </span><span style="color:#e6db74;">&quot;workers&quot;</span><span style="color:#f8f8f2;">: [
      {
         </span><span style="color:#e6db74;">&quot;type&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#e6db74;">&quot;router&quot;</span><span style="color:#f8f8f2;">,
         </span><span style="color:#e6db74;">&quot;realms&quot;</span><span style="color:#f8f8f2;">: [
            {
               </span><span style="color:#e6db74;">&quot;name&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#e6db74;">&quot;lockr&quot;</span><span style="color:#f8f8f2;">,
               </span><span style="color:#e6db74;">&quot;roles&quot;</span><span style="color:#f8f8f2;">: [
                  {
                     </span><span style="color:#e6db74;">&quot;name&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#e6db74;">&quot;anonymous&quot;</span><span style="color:#f8f8f2;">,
                     </span><span style="color:#e6db74;">&quot;permissions&quot;</span><span style="color:#f8f8f2;">: [
                        {
                           </span><span style="color:#e6db74;">&quot;uri&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#e6db74;">&quot;*&quot;</span><span style="color:#f8f8f2;">,
                           </span><span style="color:#e6db74;">&quot;publish&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#ae81ff;">true</span><span style="color:#f8f8f2;">,
                           </span><span style="color:#e6db74;">&quot;subscribe&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#ae81ff;">true</span><span style="color:#f8f8f2;">,
                           </span><span style="color:#e6db74;">&quot;call&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#ae81ff;">true</span><span style="color:#f8f8f2;">,
                           </span><span style="color:#e6db74;">&quot;register&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#ae81ff;">true
                        </span><span style="color:#f8f8f2;">}
                     ]
                  }
               ]
            }
         ],
         </span><span style="color:#e6db74;">&quot;transports&quot;</span><span style="color:#f8f8f2;">: [
            {
               </span><span style="color:#e6db74;">&quot;type&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#e6db74;">&quot;web&quot;</span><span style="color:#f8f8f2;">,
               </span><span style="color:#e6db74;">&quot;endpoint&quot;</span><span style="color:#f8f8f2;">: {
                  </span><span style="color:#e6db74;">&quot;type&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#e6db74;">&quot;tcp&quot;</span><span style="color:#f8f8f2;">,
                  </span><span style="color:#e6db74;">&quot;port&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#ae81ff;">8080
               </span><span style="color:#f8f8f2;">},
               </span><span style="color:#e6db74;">&quot;paths&quot;</span><span style="color:#f8f8f2;">: {
                  </span><span style="color:#e6db74;">&quot;/&quot;</span><span style="color:#f8f8f2;">: {
                     </span><span style="color:#e6db74;">&quot;type&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#e6db74;">&quot;static&quot;</span><span style="color:#f8f8f2;">,
                     </span><span style="color:#e6db74;">&quot;directory&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#e6db74;">&quot;../web&quot;
                  </span><span style="color:#f8f8f2;">},
                  </span><span style="color:#e6db74;">&quot;ws&quot;</span><span style="color:#f8f8f2;">: {
                     </span><span style="color:#e6db74;">&quot;type&quot;</span><span style="color:#f8f8f2;">: </span><span style="color:#e6db74;">&quot;websocket&quot;
                  </span><span style="color:#f8f8f2;">}
               }
            }
         ]
      }
   ]
}
</span></code></pre>
<p>Le <em>realm</em> d√©fini ligne 9 repr√©sente le contexte de notre application.
Il est tout √† fait possible d'avoir plusieurs <em>realms</em> sur un m√™me
serveur, tout en garantissant un cloisonnement entre les contextes
puisque crossbar ne routera les messages qu'au sein du m√™me <em>realm</em>.</p>
<p>On d√©finit un transport web sur le port 8080 et on demande √† crossbar de
servir le contenu du r√©pertoire <em>web</em> (ligne 34). C'est l√† qu'on
mettra notre app <a href="https://angular.io/">angular</a>.</p>
<p>On informe crossbar qu'on veut faire du websocket sur /ws (ligne 38).
C'est par l√† que nos composants vont communiquer.</p>
<h3 id="serveur">Serveur</h3>
<p>J'emploie le terme <em>serveur</em> depuis le d√©but mais ce n'est pas
compl√®tement appropri√©. <a href="http://crossbar.io/">Crossbar</a> ne fait pas de
distinction entre serveur et client, pour lui il n'y a que des
composants qui causent entre eux. Du coup √† partir de maintenant on
appellera le composant gardien de la ressource <em>SeatComponent</em>.</p>
<p>Avec <em>backend_env</em>, on install la lib autobahn. On pr√©cise qu'on veut
bosser avec asyncio mais il est √©galement possible de jouer avec twisted
(cf <a href="http://autobahn.ws/python/installation.html#installing-autobahn">la
doc</a>):</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">pip install </span><span style="color:#e6db74;">&quot;autobahn[asyncio]&quot;
</span></code></pre>
<p>Il ne nous reste plus qu'√† √©crire notre composant <em>SeatComponent</em>. Rien
de bien compliqu√©, on va conserver l'√©tat de la ressource sous forme de
bool√©en: vrai si c'est libre, faux sinon. Il nous faut √©galement
conserver l'identifiant du composant ayant verrouill√© la ressource,
pour que lui seul puisse la lib√©rer.</p>
<p>On va exposer des m√©thodes en RPC:</p>
<ul>
<li>lock(id_du_client): pour demander √† verrouiller la ressource</li>
<li>unlock(id_du_client): pour faire le contraire</li>
<li>get_id(): pour demander un identifiant</li>
<li>refresh(): pour r√©√©mettre l'√©tat de la ressource. On en aura besoin
quand un nouveau front web se connectera ou que l'√©tat de la
ressource changera.</li>
</ul>
<p>√âmettre l'√©tat de la ressource √ßa veut dire publier des messages. On
aura deux messages: <strong>locked</strong> et <strong>unlocked</strong>.</p>
<p>En s'appuyant sur la <a href="http://autobahn.ws/python/wamp/programming.html#registering-procedures">doc
autobahn</a>,
notre composant ressemble √† √ßa:</p>
<pre style="background-color:#272822;">
<code><span style="color:#75715e;">#!/usr/bin/env python
</span><span style="color:#f92672;">from </span><span style="color:#f8f8f2;">asyncio </span><span style="color:#f92672;">import </span><span style="color:#f8f8f2;">coroutine
</span><span style="color:#f92672;">from </span><span style="color:#f8f8f2;">autobahn.asyncio.wamp </span><span style="color:#f92672;">import </span><span style="color:#f8f8f2;">ApplicationSession, ApplicationRunner
</span><span style="color:#f92672;">import </span><span style="color:#f8f8f2;">uuid


</span><span style="font-style:italic;color:#f92672;">class </span><span style="text-decoration:underline;color:#a6e22e;">SeatComponent</span><span style="color:#f8f8f2;">(</span><span style="text-decoration:underline;font-style:italic;color:#a6e22e;">ApplicationSession</span><span style="color:#f8f8f2;">):
    _free </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">True
    </span><span style="color:#f8f8f2;">_locker_id </span><span style="color:#f92672;">= </span><span style="color:#e6db74;">&quot;&quot;

    </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">get_id</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">self</span><span style="color:#f8f8f2;">):
        </span><span style="color:#75715e;">&quot;&quot;&quot;Get unique identifier&quot;&quot;&quot;
        </span><span style="color:#f92672;">return </span><span style="font-style:italic;color:#66d9ef;">str</span><span style="color:#f8f8f2;">(uuid.uuid4())

    </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">refresh</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">self</span><span style="color:#f8f8f2;">):
        </span><span style="color:#75715e;">&quot;&quot;&quot;Send lock/unlock events according to current seat state&quot;&quot;&quot;
        </span><span style="color:#f92672;">if </span><span style="color:#f8f8f2;">self._free:
            self.publish(</span><span style="color:#e6db74;">&#39;lockr.seat.unlocked&#39;</span><span style="color:#f8f8f2;">, self._locker_id)
        </span><span style="color:#f92672;">else</span><span style="color:#f8f8f2;">:
            self.publish(</span><span style="color:#e6db74;">&#39;lockr.seat.locked&#39;</span><span style="color:#f8f8f2;">, self._locker_id)

    </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">lock</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">self</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#fd971f;">client</span><span style="color:#f8f8f2;">):
        </span><span style="color:#75715e;">&quot;&quot;&quot;Lock the resource

        Returns True if successfully locked, False otherwise
        &quot;&quot;&quot;
        </span><span style="color:#f92672;">if not </span><span style="color:#f8f8f2;">self._free:
            </span><span style="color:#f92672;">return </span><span style="color:#ae81ff;">False
        </span><span style="color:#f92672;">else</span><span style="color:#f8f8f2;">:
            self._locker_id </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">client
            self._free </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">False
            </span><span style="color:#f8f8f2;">self.refresh()
            </span><span style="color:#f92672;">return </span><span style="color:#ae81ff;">True

    </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">unlock</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">self</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#fd971f;">client</span><span style="color:#f8f8f2;">):
        </span><span style="color:#75715e;">&quot;&quot;&quot;Release the resource

        Returns True if successfully released, False otherwise
        &quot;&quot;&quot;
        </span><span style="color:#f92672;">if not </span><span style="color:#f8f8f2;">self._free </span><span style="color:#f92672;">and </span><span style="color:#f8f8f2;">client </span><span style="color:#f92672;">== </span><span style="color:#f8f8f2;">self._locker_id:
            self._free </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">True
            </span><span style="color:#f8f8f2;">self.refresh()
            </span><span style="color:#f92672;">return </span><span style="color:#ae81ff;">True
        </span><span style="color:#f92672;">else</span><span style="color:#f8f8f2;">:
            </span><span style="color:#f92672;">return </span><span style="color:#ae81ff;">False

    </span><span style="color:#f8f8f2;">@coroutine
    </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">onJoin</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">self</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#fd971f;">details</span><span style="color:#f8f8f2;">):
        </span><span style="color:#f92672;">try</span><span style="color:#f8f8f2;">:
            </span><span style="color:#f92672;">yield from </span><span style="color:#f8f8f2;">self.register(self.get_id, </span><span style="color:#e6db74;">&#39;lockr.seat.get_id&#39;</span><span style="color:#f8f8f2;">)
            </span><span style="color:#f92672;">yield from </span><span style="color:#f8f8f2;">self.register(self.lock, </span><span style="color:#e6db74;">&#39;lockr.seat.lock&#39;</span><span style="color:#f8f8f2;">)
            </span><span style="color:#f92672;">yield from </span><span style="color:#f8f8f2;">self.register(self.unlock, </span><span style="color:#e6db74;">&#39;lockr.seat.unlock&#39;</span><span style="color:#f8f8f2;">)
            </span><span style="color:#f92672;">yield from </span><span style="color:#f8f8f2;">self.subscribe(self.refresh, </span><span style="color:#e6db74;">&#39;lockr.seat.refresh&#39;</span><span style="color:#f8f8f2;">)
        </span><span style="color:#f92672;">except </span><span style="font-style:italic;color:#66d9ef;">Exception </span><span style="color:#f92672;">as </span><span style="color:#f8f8f2;">e:
            </span><span style="color:#66d9ef;">print</span><span style="color:#f8f8f2;">(</span><span style="color:#e6db74;">&quot;Register error: </span><span style="color:#ae81ff;">{}</span><span style="color:#e6db74;">&quot;</span><span style="color:#f8f8f2;">.format(e))

</span><span style="color:#f92672;">if </span><span style="color:#f8f8f2;">__name__ </span><span style="color:#f92672;">== </span><span style="color:#e6db74;">&#39;__main__&#39;</span><span style="color:#f8f8f2;">:
    runner </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">ApplicationRunner(</span><span style="font-style:italic;color:#fd971f;">url</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&#39;ws://localhost:8080/ws&#39;</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#fd971f;">realm</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&#39;lockr&#39;</span><span style="color:#f8f8f2;">)
    runner.run(SeatComponent)
</span></code></pre>
<p>Qu'est-ce qu'on a fait ici? On a d√©fini notre composant
<em>SeatComponent</em>, muni de m√©thodes pour agir sur la ressource. Ces
m√©thodes sont expos√©es en RPC dans la m√©thode appel√©e lors de la
connexion √† crossbar (le <em>onJoin</em>): via la m√©thode <strong>register</strong>.</p>
<p>La souscription √† un √©v√©nement est similaire, on fait appel √†
<strong>subscribe</strong> en pr√©cisant l'√©v√©nement et le handler. Ici c'est la
m√©thode <em>refresh</em> qui sera appel√©e √† la r√©ception d'un √©v√©nement
'<em>lockr.seat.refresh</em>'.</p>
<p>Le <em>runner</em> d√©fini √† l'avant-derni√®re ligne est configur√© avec les
√©l√©ments renseign√©s plus t√¥t dans la configuration de crossbar.</p>
<p>On a maintenant notre composant, on peut le tester en vitesse pour
v√©rifier qu'on ne s'est pas plant√©.</p>
<p>Hop, hop, un petit composant de test:</p>
<pre style="background-color:#272822;">
<code><span style="color:#75715e;">#!/usr/bin/env python
</span><span style="color:#f92672;">from </span><span style="color:#f8f8f2;">autobahn.asyncio.wamp </span><span style="color:#f92672;">import </span><span style="color:#f8f8f2;">ApplicationSession, ApplicationRunner
</span><span style="color:#f92672;">from </span><span style="color:#f8f8f2;">asyncio </span><span style="color:#f92672;">import </span><span style="color:#f8f8f2;">coroutine


</span><span style="font-style:italic;color:#f92672;">class </span><span style="text-decoration:underline;color:#a6e22e;">TestComponent</span><span style="color:#f8f8f2;">(</span><span style="text-decoration:underline;font-style:italic;color:#a6e22e;">ApplicationSession</span><span style="color:#f8f8f2;">):
    @coroutine
    </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">onJoin</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">self</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#fd971f;">details</span><span style="color:#f8f8f2;">):
        </span><span style="color:#66d9ef;">print</span><span style="color:#f8f8f2;">(</span><span style="color:#e6db74;">&quot;session ready&quot;</span><span style="color:#f8f8f2;">)

        </span><span style="color:#f92672;">try</span><span style="color:#f8f8f2;">:
            res </span><span style="color:#f92672;">= yield from </span><span style="color:#f8f8f2;">self.call(</span><span style="color:#e6db74;">&#39;lockr.seat.get_id&#39;</span><span style="color:#f8f8f2;">)
            </span><span style="color:#66d9ef;">print</span><span style="color:#f8f8f2;">(</span><span style="color:#e6db74;">&quot;call result: </span><span style="color:#ae81ff;">{}</span><span style="color:#e6db74;">&quot;</span><span style="color:#f8f8f2;">.format(res))
        </span><span style="color:#f92672;">except </span><span style="font-style:italic;color:#66d9ef;">Exception </span><span style="color:#f92672;">as </span><span style="color:#f8f8f2;">e:
            </span><span style="color:#66d9ef;">print</span><span style="color:#f8f8f2;">(</span><span style="color:#e6db74;">&quot;call error: </span><span style="color:#ae81ff;">{0}</span><span style="color:#e6db74;">&quot;</span><span style="color:#f8f8f2;">.format(e))


</span><span style="color:#f92672;">if </span><span style="color:#f8f8f2;">__name__ </span><span style="color:#f92672;">== </span><span style="color:#e6db74;">&#39;__main__&#39;</span><span style="color:#f8f8f2;">:
    runner </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">ApplicationRunner(</span><span style="font-style:italic;color:#fd971f;">url</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&#39;ws://localhost:8080/ws&#39;</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#fd971f;">realm</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&#39;lockr&#39;</span><span style="color:#f8f8f2;">)
    runner.run(TestComponent)
</span></code></pre>
<p>Normalement en lan√ßant le serveur et le test, on devrait obtenir un truc
comme √ßa:</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">session ready
call result: b654c12f-e036-418e-ae81-70be2b10258a
</span></code></pre>
<p>Comme sur des roulettes, on peut passer √† la partie front pour afficher
un joli bouton.</p>
<h2 id="frontend">Frontend</h2>
<p>Vous vous souvenez du r√©pertoire <strong>web</strong> dont on avait parl√© dans la
conf crossbar? Ben c'est l√†-dedans qu'on va se mettre.</p>
<p>Comme on est pas des gros sales, on va g√©rer nos d√©pendances avec
<a href="http://bower.io/">bower</a>:</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">bower init
bower install angular angular-wamp bootstrap --save
</span></code></pre>
<p>On installe donc <a href="https://angular.io/">angular</a>, angular-wamp et
bootstrap. On pourrait utiliser directement autobahnjs, mais puisque
<a href="https://github.com/voryx/angular-wamp">angular-wamp</a> nous offre un
service pour faire du WAMP, pourquoi se priver?</p>
<p>Bootstrap c'est pour faire un front hyper original. Pour afficher un
bouton c'est bien n√©cessaire. Enfin il faut avouer que je suis une
quiche en design...</p>
<p>On se cr√©er un <em>index.html</em> de base:</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">&lt;!</span><span style="color:#f92672;">DOCTYPE </span><span style="color:#ae81ff;">html</span><span style="color:#f8f8f2;">&gt;
&lt;</span><span style="color:#f92672;">html </span><span style="color:#a6e22e;">lang</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;en&quot;</span><span style="color:#f8f8f2;">&gt;
    &lt;</span><span style="color:#f92672;">head</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">meta </span><span style="color:#a6e22e;">charset</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;UTF-8&quot;</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">meta </span><span style="color:#a6e22e;">http-equiv</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;X-UA-Compatible&quot; </span><span style="color:#a6e22e;">content</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;IE=edge&quot;</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">meta </span><span style="color:#a6e22e;">name</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;viewport&quot; </span><span style="color:#a6e22e;">content</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;width=device-width, initial-scale=1&quot;</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">title</span><span style="color:#f8f8f2;">&gt;Lockr&lt;/</span><span style="color:#f92672;">title</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">link </span><span style="color:#a6e22e;">href</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;bower_components/bootstrap/dist/css/bootstrap.min.css&quot; </span><span style="color:#a6e22e;">rel</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;stylesheet&quot;</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">link </span><span style="color:#a6e22e;">href</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;bower_components/bootstrap/dist/css/bootstrap-theme.min.css&quot; </span><span style="color:#a6e22e;">rel</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;stylesheet&quot;</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">link </span><span style="color:#a6e22e;">href</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;style.css&quot; </span><span style="color:#a6e22e;">rel</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;stylesheet&quot;</span><span style="color:#f8f8f2;">&gt;
    &lt;/</span><span style="color:#f92672;">head</span><span style="color:#f8f8f2;">&gt;
    &lt;</span><span style="color:#f92672;">body</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">script </span><span style="color:#a6e22e;">src</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;bower_components/jquery/dist/jquery.min.js&quot;</span><span style="color:#f8f8f2;">&gt;&lt;/</span><span style="color:#f92672;">script</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">script </span><span style="color:#a6e22e;">src</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;bower_components/bootstrap/dist/js/bootstrap.min.js&quot;</span><span style="color:#f8f8f2;">&gt;&lt;/</span><span style="color:#f92672;">script</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">script </span><span style="color:#a6e22e;">src</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;bower_components/angular/angular.min.js&quot;</span><span style="color:#f8f8f2;">&gt;&lt;/</span><span style="color:#f92672;">script</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">script </span><span style="color:#a6e22e;">src</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;bower_components/autobahn/autobahn.min.js&quot;</span><span style="color:#f8f8f2;">&gt;&lt;/</span><span style="color:#f92672;">script</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">script </span><span style="color:#a6e22e;">src</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;bower_components/angular-wamp/release/angular-wamp.min.js&quot;</span><span style="color:#f8f8f2;">&gt;&lt;/</span><span style="color:#f92672;">script</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">script </span><span style="color:#a6e22e;">src</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;app.js&quot;</span><span style="color:#f8f8f2;">&gt;&lt;/</span><span style="color:#f92672;">script</span><span style="color:#f8f8f2;">&gt;
    &lt;/</span><span style="color:#f92672;">body</span><span style="color:#f8f8f2;">&gt;
&lt;/</span><span style="color:#f92672;">html</span><span style="color:#f8f8f2;">&gt;
</span></code></pre>
<p>Outre les d√©pendances, on appelle <em>style.css</em> pour mettre le bouton en
taille maxi et <em>app.js</em> qui contiendra notre appli angular.</p>
<p>D√©clarons notre application:</p>
<pre style="background-color:#272822;">
<code><span style="font-style:italic;color:#66d9ef;">var </span><span style="color:#f8f8f2;">app </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">angular.module(</span><span style="color:#e6db74;">&#39;LockrWebApp&#39;</span><span style="color:#f8f8f2;">, [</span><span style="color:#e6db74;">&#39;vxWamp&#39;</span><span style="color:#f8f8f2;">]);
</span></code></pre>
<p>Une unique d√©pendance: angular-wamp, qu'on s'empresse de configurer:</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">app.config([</span><span style="color:#e6db74;">&#39;$wampProvider&#39;</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">function</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">$wampProvider</span><span style="color:#f8f8f2;">) {
  $wampProvider.init({
    url: </span><span style="color:#e6db74;">&#39;ws://localhost:8080/ws&#39;</span><span style="color:#f8f8f2;">,
    realm: </span><span style="color:#e6db74;">&#39;lockr&#39;
  </span><span style="color:#f8f8f2;">});
}]);
</span></code></pre>
<p>On pr√©cise le realm et l'url qu'on avait configur√© dans
.crossbar/config.json.</p>
<p>Reste plus qu'√† √©crire notre contr√¥leur:</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">app.controller(</span><span style="color:#e6db74;">&#39;MainCtrl&#39;</span><span style="color:#f8f8f2;">, [</span><span style="color:#e6db74;">&#39;$scope&#39;</span><span style="color:#f8f8f2;">, </span><span style="color:#e6db74;">&#39;$wamp&#39;</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">function</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">$scope</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#fd971f;">$wamp</span><span style="color:#f8f8f2;">) {

  </span><span style="color:#75715e;">// C&#39;est l&#39;identifiant du client
  </span><span style="font-style:italic;color:#66d9ef;">var </span><span style="color:#f8f8f2;">uuid;

  </span><span style="color:#75715e;">// Le bouton est initialis√© d√©sactiv√©
  </span><span style="color:#f8f8f2;">$scope.seat_state </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">false</span><span style="color:#f8f8f2;">;
  $scope.btn_msg </span><span style="color:#f92672;">= </span><span style="color:#e6db74;">&quot;Wait for it...&quot;</span><span style="color:#f8f8f2;">;
  $scope.btn_disabled </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">true</span><span style="color:#f8f8f2;">;

  </span><span style="color:#75715e;">// En cas d&#39;erreur on d√©sactive le bouton
  // et on affiche un message fort √† propos
  </span><span style="font-style:italic;color:#66d9ef;">function </span><span style="color:#a6e22e;">handleError</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">err</span><span style="color:#f8f8f2;">) {
    $scope.error </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">err;
    $scope.btn_disabled </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">true</span><span style="color:#f8f8f2;">;
    $scope.seat_state </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">false</span><span style="color:#f8f8f2;">;
    $scope.btn_msg </span><span style="color:#f92672;">= </span><span style="color:#e6db74;">&quot;Shit happened :/&quot;</span><span style="color:#f8f8f2;">;
  }

  </span><span style="color:#75715e;">// On souscrit √† l&#39;√©v√©nement &#39;lockr.seat.unlocked&#39;
  // pour activer le bouton et ajuster le message.
  </span><span style="color:#f8f8f2;">$wamp.subscribe(</span><span style="color:#e6db74;">&#39;lockr.seat.unlocked&#39;</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">function</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">locker_id</span><span style="color:#f8f8f2;">) {
    $scope.btn_msg </span><span style="color:#f92672;">= </span><span style="color:#e6db74;">&quot;Lock the seat&quot;</span><span style="color:#f8f8f2;">;
    $scope.seat_state </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">true</span><span style="color:#f8f8f2;">;
    $scope.btn_disabled </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">false</span><span style="color:#f8f8f2;">;
  });

  </span><span style="color:#75715e;">// Idem pour l&#39;√©v√©nement &#39;lockr.seat.locked&#39;
  // mais si c&#39;est nous qui avons verrouill√© les chiottes,
  // on fait en sorte de pouvoir les d√©verrouiller.
  </span><span style="color:#f8f8f2;">$wamp.subscribe(</span><span style="color:#e6db74;">&#39;lockr.seat.locked&#39;</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">function</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">locker_id</span><span style="color:#f8f8f2;">) {
    $scope.seat_state </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">false</span><span style="color:#f8f8f2;">;
    </span><span style="color:#f92672;">if </span><span style="color:#f8f8f2;">(locker_id </span><span style="color:#f92672;">== </span><span style="color:#f8f8f2;">uuid) {
      $scope.btn_msg </span><span style="color:#f92672;">= </span><span style="color:#e6db74;">&quot;Release the seat&quot;</span><span style="color:#f8f8f2;">;
    } </span><span style="color:#f92672;">else </span><span style="color:#f8f8f2;">{
      $scope.btn_msg </span><span style="color:#f92672;">= </span><span style="color:#e6db74;">&quot;The seat is locked by someone else&quot;</span><span style="color:#f8f8f2;">;
      $scope.btn_disabled </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">true</span><span style="color:#f8f8f2;">;
    }
  });

  </span><span style="color:#75715e;">// On r√©cup√®re un ID unique.
  // Notez qu&#39;on se fout de savoir qui fournit la m√©thode &#39;get_id&#39;.
  // Ici c&#39;est SeatComponent, mais √ßa pourrait √™tre un autre composant.
  </span><span style="color:#f8f8f2;">$wamp.call(</span><span style="color:#e6db74;">&#39;lockr.seat.get_id&#39;</span><span style="color:#f8f8f2;">).then(
    </span><span style="font-style:italic;color:#66d9ef;">function</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">res</span><span style="color:#f8f8f2;">) {
      uuid </span><span style="color:#f92672;">= </span><span style="color:#f8f8f2;">res;
    }, handleError
  );

  </span><span style="color:#75715e;">// On balance un refresh pour mettre √† jour le front en fonction
  // de l&#39;√©tat actuel de la ressource.
  </span><span style="color:#f8f8f2;">$wamp.publish(</span><span style="color:#e6db74;">&#39;lockr.seat.refresh&#39;</span><span style="color:#f8f8f2;">);

  </span><span style="color:#75715e;">// C&#39;est la m√©thode appell√©e au clic du bouton, on agit en fonction
  // de l&#39;√©tat de la ressource: on verrouille ou on d√©verrouille.
  </span><span style="font-style:italic;color:#66d9ef;">$scope</span><span style="color:#f8f8f2;">.</span><span style="color:#a6e22e;">toggleLock </span><span style="color:#f92672;">= </span><span style="font-style:italic;color:#66d9ef;">function</span><span style="color:#f8f8f2;">() {
    </span><span style="color:#f92672;">if </span><span style="color:#f8f8f2;">($scope.seat_state) {
      $wamp.call(</span><span style="color:#e6db74;">&#39;lockr.seat.lock&#39;</span><span style="color:#f8f8f2;">, [uuid]).then(
        </span><span style="font-style:italic;color:#66d9ef;">function</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">res</span><span style="color:#f8f8f2;">) {
          </span><span style="color:#f92672;">if </span><span style="color:#f8f8f2;">(res) {
            $scope.seat_state </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">false</span><span style="color:#f8f8f2;">;
          }
        }, handleError);
    } </span><span style="color:#f92672;">else </span><span style="color:#f8f8f2;">{
      $wamp.call(</span><span style="color:#e6db74;">&#39;lockr.seat.unlock&#39;</span><span style="color:#f8f8f2;">, [uuid]).then(
        </span><span style="font-style:italic;color:#66d9ef;">function</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">res</span><span style="color:#f8f8f2;">) {
          </span><span style="color:#f92672;">if </span><span style="color:#f8f8f2;">(res) {
            $scope.seat_state </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">true</span><span style="color:#f8f8f2;">;
          }
        }, handleError);
    }
  };
}]);
</span></code></pre>
<p>Il ne nous reste plus qu'√† ajouter quelques √©l√©ments dans notre
<em>index.html</em>:</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">&lt;</span><span style="color:#f92672;">body </span><span style="color:#a6e22e;">ng-app</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;LockrWebApp&quot; </span><span style="color:#a6e22e;">ng-controller</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;MainCtrl&quot;</span><span style="color:#f8f8f2;">&gt;

    </span><span style="color:#75715e;">&lt;!-- Un bloc pour afficher les erreurs --&gt;
    </span><span style="color:#f8f8f2;">&lt;</span><span style="color:#f92672;">div </span><span style="color:#a6e22e;">class</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;container&quot;</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">div </span><span style="color:#a6e22e;">ng-if</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;error&quot; </span><span style="color:#a6e22e;">class</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;alert alert-danger&quot;</span><span style="color:#f8f8f2;">&gt;
            &lt;</span><span style="color:#f92672;">p</span><span style="color:#f8f8f2;">&gt;There has been an error. Make sure the server and the router are running and reload the page.&lt;/</span><span style="color:#f92672;">p</span><span style="color:#f8f8f2;">&gt;
            &lt;</span><span style="color:#f92672;">p</span><span style="color:#f8f8f2;">&gt;{{error}}&lt;/</span><span style="color:#f92672;">p</span><span style="color:#f8f8f2;">&gt;
        &lt;/</span><span style="color:#f92672;">div</span><span style="color:#f8f8f2;">&gt;
    &lt;/</span><span style="color:#f92672;">div</span><span style="color:#f8f8f2;">&gt;

    </span><span style="color:#75715e;">&lt;!-- Notre maxi bouton --&gt;
    </span><span style="color:#f8f8f2;">&lt;</span><span style="color:#f92672;">div </span><span style="color:#a6e22e;">class</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;container text-center maxi-btn&quot;</span><span style="color:#f8f8f2;">&gt;
        &lt;</span><span style="color:#f92672;">button </span><span style="color:#a6e22e;">ng-class</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;{&#39;btn-primary&#39;: seat_state, &#39;btn-danger&#39;: !seat_state &amp;&amp; btn_disabled, &#39;btn-warning&#39;: !seat_state &amp;&amp; !btn_disabled}&quot;
            </span><span style="color:#a6e22e;">class</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;btn btn-block&quot; </span><span style="color:#a6e22e;">ng-disabled</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;error || btn_disabled&quot; </span><span style="color:#a6e22e;">ng-click</span><span style="color:#f8f8f2;">=</span><span style="color:#e6db74;">&quot;toggleLock()&quot;</span><span style="color:#f8f8f2;">&gt;{{btn_msg}}&lt;/</span><span style="color:#f92672;">button</span><span style="color:#f8f8f2;">&gt;
    &lt;/</span><span style="color:#f92672;">div</span><span style="color:#f8f8f2;">&gt;

    </span><span style="color:#75715e;">&lt;!-- Les scripts qui vont bien --&gt;</span><span style="color:#f8f8f2;">
    [...]
&lt;/</span><span style="color:#f92672;">body</span><span style="color:#f8f8f2;">&gt;
</span></code></pre>
<p>Et si on teste maintenant, qu'est-ce qui se passe? Rien.</p>
<p><img src="https://media.giphy.com/media/3uyIgVxP1qAjS/giphy.gif" alt="√áa marche pas..." /></p>
<p>Il nous manque une √©tape: la connexion √† crossbar. √áa se passe dans
<em>app.js</em>, o√π on ajoute:</p>
<pre style="background-color:#272822;">
<code><span style="color:#f8f8f2;">app.run([</span><span style="color:#e6db74;">&#39;$wamp&#39;</span><span style="color:#f8f8f2;">, </span><span style="font-style:italic;color:#66d9ef;">function</span><span style="color:#f8f8f2;">(</span><span style="font-style:italic;color:#fd971f;">$wamp</span><span style="color:#f8f8f2;">) {
  $wamp.open();
}
</span></code></pre>
<p>La doc d'<a href="https://github.com/voryx/angular-wamp">angular-wamp</a> pr√©ciser
qu'on pourrait ouvrir la connexion de n'importe o√π. N'importe o√π y
compris au d√©marrage de l'application.</p>
<h2 id="bilan">Bilan</h2>
<p>Aller, on a tout ce qu'il nous faut:</p>
<ul>
<li>on d√©marre crossbar (crossbar start, depuis <em>crossbar_env</em>)</li>
<li>on lance le serveur (SeatComponent, depuis <em>backend_env</em>)</li>
<li>on ouvre un navigateur sur <a href="http://localhost:8080">http://localhost:8080</a></li>
</ul>
<p>Et l√†, on voit un joli bouton &quot;Lock the seat&quot;. Maintenant on ouvre
deux ou trois autres onglets, et on sourit en pensant au temps qu'on ne
perdra pas en se levant pour rien.</p>
<p>Pour les ceusses qui se demanderait, le code est <a href="https://github.com/greizgh/lockr">en
ligne</a>.</p>
<p>Avant de mettre en prod (rien que √ßa), il nous restera √† remplacer tous
les <em>localhost</em> par le hostname de la machine qui servira
l'application.</p>
<p>M√™me si notre application r√©pond au probl√®me de d√©part, il existe
quelques limites:</p>
<ul>
<li>Identifier les utilisateurs par un UUID est contraignant: si
l'utilisateur ferme un onglet ou recharge la page alors qu'il a
verrouill√© la ressource, personne ne pourra la d√©verrouiller.</li>
<li>L'identifiant de l'utilisateur verrouillant la ressource est
envoy√© avec le message '<em>lockr.seat.locked</em>'. Il est tr√®s simple
de <em>tricher</em> et de lancer un message '<em>lockr.seat.unlock</em>' avec
l'uuid r√©cup√©r√©.</li>
</ul>
<p>Il est √©vident que l'int√©r√™t de notre application est tr√®s limit√©,
c'√©tait plus pour avoir une raison de jouer avec
<a href="http://crossbar.io/">crossbar</a>, <a href="https://www.python.org/">python</a> et
<a href="https://angular.io/">angular</a>. On pourrait aller plus loin en imaginant
un syst√®me de file d'attente, identifier les utilisateurs par leur IP
ou faire en sorte que l'identifiant de l'entit√© posant le verrou ne
soit pas divulgu√©. De la m√™me mani√®re, on ne g√®re qu'une unique
ressource, mais on pourrait √©tendre le syst√®me pour g√©rer les toilettes
pour dames, une bouilloire ou la machine √† caf√©.</p>
<p>√áa a √©t√© l'occasion de voir:</p>
<ul>
<li>comment d√©finir une m√©thode appelable en RPC</li>
<li>comment effectuer un appel RPC (dans <em>TestComponent</em>)</li>
<li>comment souscrire √† un √©v√©nement</li>
<li>comment publier un message (dans la m√©thode <em>refresh</em> de
<em>SeatComponent</em>)</li>
</ul>
<p><a href="http://crossbar.io/">Crossbar</a> c'est bon, mangez-en. On a travaill√©
ici avec angular et python, mais on aurait tout aussi bien pu bosser en
C++ avec des composants sur Android. Les diff√©rents bindings existants
sont list√©s sur la page d'<a href="http://autobahn.ws/">autobahn</a>.</p>

    </div>
  </article>
</div>

    </div>

    <footer class="mt5 pa3 bg-dark-gray near-white">
      <div class="tc mt3">
        
        <a class="link black hover-silver dib h2 w2" href="https://github.com/greizgh" title="GitHub">
          <svg fill="currentColor" viewBox="0 0 24 24">
    <path d="M5,3H19A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H14.56C14.24,20.93 14.23,20.32 14.23,20.11L14.24,17.64C14.24,16.8 13.95,16.25 13.63,15.97C15.64,15.75 17.74,15 17.74,11.53C17.74,10.55 17.39,9.74 16.82,9.11C16.91,8.89 17.22,7.97 16.73,6.73C16.73,6.73 15.97,6.5 14.25,7.66C13.53,7.46 12.77,7.36 12,7.35C11.24,7.36 10.46,7.46 9.75,7.66C8.03,6.5 7.27,6.73 7.27,6.73C6.78,7.97 7.09,8.89 7.18,9.11C6.61,9.74 6.26,10.55 6.26,11.53C6.26,15 8.36,15.75 10.36,16C10.1,16.2 9.87,16.6 9.79,17.18C9.27,17.41 7.97,17.81 7.17,16.43C7.17,16.43 6.69,15.57 5.79,15.5C5.79,15.5 4.91,15.5 5.73,16.05C5.73,16.05 6.32,16.33 6.73,17.37C6.73,17.37 7.25,19.12 9.76,18.58L9.77,20.11C9.77,20.32 9.75,20.93 9.43,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3Z" />
          </svg>
        </a>
        <a class="link black hover-silver dib h2 w2" href="https://gitlab.com/greizgh" title="GitLab">
          <svg fill="currentColor" viewBox="0 0 586 559">
            <path d="M461.514,298.355l-18.049-55.587c0.008,0.025,0.011,0.051,0.019,0.076c-0.009-0.029-0.014-0.058-0.022-0.087
                     c-0.001-0.002-0.001-0.003-0.001-0.005c0-0.001,0-0.002,0-0.002l-35.83-110.31c-1.96-5.811-7.353-9.711-13.536-9.663
                     c-6.201,0.032-11.446,3.857-13.364,9.748L346.721,237.23H239.408l-34.074-104.712c-1.916-5.886-7.162-9.71-13.362-9.742
                     c-0.025,0-0.049,0-0.075,0c-6.105,0-11.509,3.876-13.49,9.752l-35.732,110.211l-0.005,0.014c0,0.001,0,0.002,0,0.003
                     c-0.009,0.028-0.013,0.056-0.022,0.084c0.008-0.025,0.011-0.051,0.019-0.076l-18.115,55.591c-2.725,8.392,0.232,17.512,7.36,22.697
                     L288.328,434.7c0.023,0.017,0.049,0.027,0.072,0.044c0.067,0.048,0.132,0.097,0.2,0.142c-0.064-0.043-0.124-0.09-0.187-0.134
                     c0,0,0-0.001-0.001-0.001c0.01,0.008,0.022,0.013,0.033,0.02c0.009,0.006,0.018,0.01,0.027,0.016
                     c0.001,0.001,0.002,0.002,0.004,0.003c0.242,0.168,0.493,0.322,0.753,0.463c0.036,0.02,0.068,0.045,0.104,0.064
                     c0.001,0,0.001,0.001,0.002,0.001c0.022,0.011,0.042,0.025,0.064,0.036c0.017,0.008,0.035,0.013,0.051,0.021
                     c0.012,0.006,0.025,0.01,0.037,0.015c0.029,0.014,0.061,0.023,0.09,0.038c0.136,0.065,0.279,0.118,0.419,0.175
                     c0.131,0.054,0.258,0.117,0.392,0.164c0.006,0.002,0.011,0.005,0.017,0.007c0.022,0.008,0.042,0.019,0.065,0.027
                     c0.028,0.01,0.055,0.021,0.083,0.03c0.011,0.003,0.022,0.005,0.033,0.008c0.035,0.011,0.073,0.016,0.108,0.026
                     c0.013,0.004,0.028,0.006,0.042,0.01c0.188,0.057,0.383,0.098,0.577,0.141c0.076,0.017,0.149,0.041,0.226,0.055
                     c0.011,0.002,0.021,0.006,0.033,0.008c0.025,0.005,0.048,0.014,0.074,0.018c0.041,0.007,0.081,0.02,0.123,0.026
                     c0.033,0.005,0.067,0.003,0.1,0.008c0.006,0.001,0.011,0,0.017,0.001c0.002,0,0.003,0,0.005,0c0.369,0.053,0.743,0.09,1.124,0.09
                     c0.002,0,0.004,0,0.007,0l0,0c0.001,0,0.002,0,0.002,0c0,0,0.001,0,0.001,0c0.001,0,0.002,0,0.003,0
                     c0.382,0,0.756-0.037,1.126-0.09c0.001,0,0.003,0,0.004,0c0.006-0.001,0.012,0,0.018-0.001c0.033-0.005,0.068-0.003,0.101-0.008
                     c0.042-0.007,0.082-0.019,0.124-0.026c0.025-0.004,0.048-0.013,0.073-0.018c0.011-0.002,0.021-0.006,0.032-0.008
                     c0.078-0.015,0.153-0.039,0.231-0.056c0.191-0.042,0.383-0.083,0.57-0.139c0.013-0.004,0.026-0.005,0.039-0.009
                     c0.037-0.011,0.075-0.016,0.112-0.027c0.011-0.004,0.023-0.005,0.034-0.008c0.029-0.009,0.057-0.021,0.085-0.031
                     c0.022-0.008,0.042-0.019,0.064-0.027c0.006-0.002,0.011-0.005,0.017-0.007c0.142-0.05,0.276-0.116,0.415-0.173
                     c0.129-0.054,0.261-0.102,0.387-0.162c0.031-0.015,0.064-0.024,0.094-0.039c0.012-0.006,0.026-0.01,0.038-0.016
                     c0.017-0.008,0.035-0.013,0.052-0.022c0.023-0.012,0.045-0.026,0.067-0.037c0,0,0.001,0,0.001-0.001
                     c0.037-0.019,0.07-0.046,0.107-0.066c0.258-0.14,0.508-0.293,0.749-0.46c0.019-0.013,0.041-0.023,0.061-0.037
                     c0.005-0.004,0.011-0.006,0.016-0.01c0.023-0.017,0.05-0.028,0.073-0.045l156.44-113.65
                     C461.282,315.867,464.239,306.747,461.514,298.355z M394.194,142.774l30.68,94.456h-61.36L394.194,142.774z M419.501,253.202
                     l-12.519,16.041L314.648,387.55l43.677-134.348H419.501z M285.428,430.707C285.428,430.707,285.428,430.707,285.428,430.707
                     c0.008,0.024,0.021,0.046,0.029,0.071C285.449,430.753,285.436,430.731,285.428,430.707z M271.42,387.558L166.624,253.202l0,0
                     h61.18L271.42,387.558z M191.875,142.773l30.737,94.457h-61.36L191.875,142.773z M141.304,308.133
                     c-1.516-1.103-2.144-3.05-1.563-4.838l13.466-41.325l98.67,126.502L141.304,308.133z M288.053,434.489
                     c-0.031-0.025-0.061-0.052-0.091-0.078c-0.006-0.005-0.012-0.012-0.019-0.017c-0.06-0.05-0.119-0.101-0.177-0.153
                     c-0.114-0.099-0.226-0.2-0.333-0.306c0.009,0.008,0.019,0.015,0.028,0.023c0.012,0.011,0.025,0.02,0.037,0.031
                     c0.229,0.219,0.47,0.425,0.722,0.615c0.003,0.002,0.005,0.005,0.008,0.007c0.012,0.009,0.022,0.02,0.034,0.03
                     C288.193,434.591,288.121,434.543,288.053,434.489z M293.028,402.392l-25.665-79.059l-22.766-70.131h96.933L293.028,402.392z
                     M298.281,434.241c-0.06,0.052-0.118,0.104-0.179,0.154c-0.007,0.006-0.014,0.013-0.021,0.019c-0.031,0.025-0.06,0.052-0.09,0.077
                     c-0.066,0.053-0.138,0.101-0.207,0.152c0.012-0.009,0.022-0.021,0.035-0.029c0.002-0.002,0.004-0.004,0.006-0.006
                     c0.252-0.19,0.492-0.394,0.719-0.613c0.009-0.009,0.02-0.016,0.029-0.024c0.012-0.011,0.025-0.02,0.036-0.031
                     C298.503,434.043,298.392,434.143,298.281,434.241z M444.766,308.13l-110.557,80.317l98.703-126.467l13.412,41.307
                     C446.906,305.083,446.279,307.03,444.766,308.13z"/>
          </svg>
        </a>
      </div>


      <small class="ma1 db tc gray">Carefully handcrafted with ‚ù§ - CC-BY-NC-SA</small>
    </footer>

    
    
  </body>

</html>
